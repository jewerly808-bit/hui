<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KanzleiPlus - KI-Antwort</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --accent: #1C3A52; 
            --accent-hover: #15293B; 
            --accent-light: rgba(28,58,82,0.1); 
            --accent-lighter: rgba(28,58,82,0.05);
            --bg-primary: #FFFFFF; 
            --bg-secondary: #F8FAFB; 
            --bg-tertiary: #F3F4F6; 
            --bg-elevated: #FFFFFF;
            --text-primary: #111827; 
            --text-secondary: #6B7280; 
            --text-tertiary: #9CA3AF;
            --border: #E5E7EB; 
            --border-light: #F3F4F6;
            --success: #10B981; 
            --success-light: rgba(16,185,129,0.1);
            --warning: #F59E0B; 
            --warning-light: rgba(245,158,11,0.1);
            --error: #EF4444; 
            --error-light: rgba(239,68,68,0.1);
            --info: #3B82F6; 
            --info-light: rgba(59,130,246,0.1);
            --shadow-xs: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-sm: 0 1px 3px 0 rgba(0,0,0,0.1), 0 1px 2px -1px rgba(0,0,0,0.1);
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-md: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0,0,0,0.1), 0 8px 10px -6px rgba(0,0,0,0.1);
            --shadow-xl: 0 25px 50px -12px rgba(0,0,0,0.25);
            --transition-fast: all .15s cubic-bezier(.4,0,.2,1);
            --transition: all .2s cubic-bezier(.4,0,.2,1);
            --transition-slow: all .3s cubic-bezier(.4,0,.2,1);
            --control-h: 52px;
        }

        body { 
            font-family: -apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            line-height: 1.6; 
            -webkit-font-smoothing: antialiased; 
            -moz-osx-font-smoothing: grayscale; 
            overflow: hidden;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Tab Navigation Header */
        .tab-header {
            height: 50px;
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: stretch;
            flex-shrink: 0;
        }

        .tab-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: none;
            border-right: 1px solid var(--border-light);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .tab-button.active {
            background: var(--bg-primary);
            color: var(--accent);
            font-weight: 600;
        }

        .tab-button svg {
            width: 24px;
            height: 24px;
            stroke: currentColor;
        }

        /* Content Container */
        .content-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .tab-content {
            display: none;
            flex: 1;
            overflow: hidden;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        .empty-tab {
            flex: 1;
            background: var(--bg-primary);
        }

        /* ================================
           DASHBOARD STYLES
           ================================ */
        
        .dashboard-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: var(--bg-primary);
        }

        .dashboard-section {
            margin-bottom: 20px;
        }

        .section-header-dash {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }

        .section-title-dash {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .section-icon-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: var(--transition);
        }

        .section-icon-btn:hover {
            background: var(--accent-light);
            color: var(--accent);
            border-color: var(--accent);
        }

        .section-icon-btn svg {
            transition: transform 0.5s ease;
        }

        .summary-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .summary-card:hover {
            border-color: var(--border);
            box-shadow: var(--shadow-xs);
        }

        .summary-text {
            flex: 1;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .summary-arrow {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .quick-replies {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .quick-reply-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 10px;
            padding: 14px 16px;
            font-size: 14px;
            color: var(--text-primary);
            text-align: left;
            cursor: pointer;
            transition: var(--transition);
            font-family: inherit;
            width: 100%;
        }

        .quick-reply-btn:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            color: var(--accent);
        }

        /* ================================
           CHAT STYLES
           ================================ */
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
            overflow: hidden;
        }

        .chat-messages-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .chat-messages {
            flex: 1;
            height: 100%;
            overflow-y: scroll;
            overflow-x: hidden;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            scrollbar-width: none;
            -ms-overflow-style: none;
            position: relative;
        }

        .chat-messages::-webkit-scrollbar {
            display: none;
        }

        .chat-message {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }

        .chat-message.ai {
            align-self: flex-start;
        }

        .chat-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .chat-message.user .message-avatar {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border-light);
        }

        .message-bubble {
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 14px;
            font-size: 14px;
            line-height: 1.6;
            color: var(--text-primary);
        }

        .chat-message.user .message-bubble {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .chat-input-area {
            padding: 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
        }

        .chat-input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }

        .chat-input-container {
            flex: 1;
            position: relative;
        }

        .chat-input {
            width: 100%;
            flex: 1;
            min-height: 44px;
            max-height: 120px;
            padding: 12px 14px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 12px;
            font-family: inherit;
            font-size: 14px;
            color: var(--text-primary);
            resize: none;
            transition: var(--transition);
            line-height: 1.4;
            overflow-y: scroll;
            overflow-x: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .chat-input::-webkit-scrollbar {
            display: none;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--border);
            background: var(--bg-secondary);
        }

        .chat-input:hover {
            border-color: var(--border);
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .chat-send-btn {
            width: 44px;
            height: 44px;
            background: var(--accent);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            flex-shrink: 0;
        }

        .chat-send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .taskpane-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            background: var(--bg-primary);
            overflow: hidden;
        }

        /* Main Content Area */
        .taskpane-content {
            flex: 1;
            overflow: hidden;
            padding: 16px;
            display: flex;
            flex-direction: column;
            background: var(--bg-primary);
        }

        /* Response Section */
        .response-section {
            background: transparent;
            border-radius: 0;
            border: none;
            padding: 0;
            margin-bottom: 0;
            box-shadow: none;
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        /* Response Text Container mit versteckter nativer Scrollbar */
        .response-text-wrapper {
            position: relative;
            flex: 1;
            min-height: 0;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .section-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-icon {
            width: 20px;
            height: 20px;
            color: var(--accent);
        }

        .regenerate-btn {
            padding: 6px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .regenerate-btn:hover {
            background: var(--accent-light);
            color: var(--accent);
            border-color: var(--accent);
        }

        .response-text {
            width: 100%;
            height: 100%;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-primary);
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: inherit;
            border: 1px solid var(--border-light);
            border-radius: 12px;
            padding: 12px;
            padding-right: 12px;
            background: var(--bg-secondary);
            resize: none;
            transition: var(--transition);
            overflow-y: scroll;
            overflow-x: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .response-text::-webkit-scrollbar {
            display: none;
        }

        .response-text:focus {
            outline: none;
            border-color: var(--border);
            background: var(--bg-secondary);
            box-shadow: none;
        }

        .response-text:hover {
            border-color: var(--border);
        }

        /* Custom Scrollbar */
        .custom-scrollbar {
            position: absolute;
            right: 1px;
            top: 0;
            bottom: 0;
            width: 10px;
            background: transparent;
            border-radius: 12px;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .custom-scrollbar.visible {
            opacity: 1;
        }

        .custom-scrollbar-thumb {
            position: absolute;
            right: 0;
            width: 6px;
            background: #D1D5DB;
            border-radius: 8px;
            cursor: pointer;
            pointer-events: auto;
            transition: background 0.2s ease, width 0.2s ease;
        }

        .custom-scrollbar-thumb:hover {
            background: #9CA3AF;
            width: 8px;
        }

        .custom-scrollbar-thumb:active {
            background: #9CA3AF;
            width: 8px;
        }

        /* Sources Section - Collapsible */
        .sources-wrapper {
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
            position: relative;
        }

        .sources-section {
            background: var(--bg-primary);
            border-bottom: 1px solid var(--border-light);
            transition: var(--transition);
        }

        .sources-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 16px;
            cursor: pointer;
            user-select: none;
            background: var(--bg-primary);
            transition: var(--transition);
        }

        .sources-toggle:hover {
            background: var(--bg-secondary);
        }

        .sources-toggle:active {
            background: var(--bg-tertiary);
        }

        .sources-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .sources-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sources-count {
            font-size: 12px;
            color: var(--text-tertiary);
            background: var(--bg-secondary);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 500;
        }

        .sources-chevron {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        .sources-section.expanded .sources-chevron {
            transform: rotate(180deg);
        }

        .sources-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sources-section.expanded .sources-content {
            max-height: 400px;
        }

        .sources-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 0 16px 16px;
        }

        .source-card {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 10px;
            border: 1px solid var(--border-light);
            transition: var(--transition);
            cursor: pointer;
        }

        .source-card:hover {
            background: var(--accent-lighter);
            border-color: var(--accent-light);
        }

        .source-icon {
            width: 36px;
            height: 36px;
            min-width: 36px;
            background: var(--info-light);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--info);
        }

        .source-content {
            flex: 1;
            min-width: 0;
        }

        .source-title {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .source-meta {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* Footer Actions */
        .taskpane-footer {
            padding: 16px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-light);
            flex-shrink: 0;
        }

        .btn-primary {
            width: 100%;
            height: var(--control-h);
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-xs);
        }

        .secondary-actions {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-secondary {
            flex: 1;
            height: var(--control-h);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: var(--accent-light);
            color: var(--accent);
            border-color: var(--accent);
        }

        /* Popup/Overlay */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(17, 24, 39, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        }

        .overlay.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .popup {
            background: var(--bg-primary);
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            width: 90%;
            max-width: 480px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to { 
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .popup-header {
            padding: 24px 24px 16px;
            border-bottom: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .popup-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .popup-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 20px;
            line-height: 1;
        }

        .popup-close:hover {
            background: var(--error-light);
            color: var(--error);
            border-color: var(--error);
        }

        .popup-content {
            padding: 24px;
            flex: 1;
            overflow-y: auto;
        }

        .form-group {
            margin-bottom: 20px;
            position: relative;
        }

        .form-label {
            display: block;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .popup-textarea-wrapper {
            position: relative;
            height: 200px;
        }

        .form-input {
            width: 100%;
            height: 100%;
            padding: 12px;
            padding-right: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-light);
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            line-height: 1.7;
            color: var(--text-primary);
            resize: none;
            transition: var(--transition);
            overflow-y: scroll;
            overflow-x: hidden;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .form-input::-webkit-scrollbar {
            display: none;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            background: var(--bg-primary);
            box-shadow: 0 0 0 3px var(--accent-light);
        }

        .form-input:hover {
            border-color: var(--border);
        }

        .form-hint {
            font-size: 12px;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        .popup-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border-light);
            display: flex;
            gap: 12px;
        }

        .btn-cancel {
            flex: 1;
            height: 48px;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .btn-cancel:hover {
            background: var(--bg-tertiary);
            border-color: var(--text-tertiary);
        }

        .btn-generate {
            flex: 2;
            height: 48px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-generate:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-generate:active {
            transform: translateY(0);
        }

        /* Loading State */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 48px 24px;
        }

        .empty-icon {
            width: 64px;
            height: 64px;
            background: var(--accent-light);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: var(--accent);
        }

        .empty-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .empty-text {
            font-size: 13px;
            color: var(--text-secondary);
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- Tab Navigation Header -->
    <div class="tab-header">
        <button class="tab-button" onclick="switchTab('dashboard')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
            </svg>
        </button>
        <button class="tab-button active" onclick="switchTab('email')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
            </svg>
        </button>
        <button class="tab-button" onclick="switchTab('steuer')">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/>
            </svg>
        </button>
    </div>

    <!-- Tab Contents -->
    <div class="content-container">
        <!-- Dashboard Tab -->
        <div class="tab-content" id="dashboardTab">
            <div class="dashboard-container">
                <!-- Zusammenfassung Section -->
                <div class="dashboard-section">
                    <div class="section-header-dash">
                        <h2 class="section-title-dash">Zusammenfassung</h2>
                        <button class="section-icon-btn" onclick="copySummary()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"/>
                            </svg>
                        </button>
                    </div>
                    <div class="summary-card" onclick="expandSummary()">
                        <div class="summary-text" id="summaryText">
                            Die eingehende E-Mail betrifft eine Anfrage zur Umsatzsteuervoranmeldung Q3 2025. Der Mandant benötigt Klärung zur steuerlichen Behandlung von Softwarelizenzen und Cloud-Services nach § 13b UStG.
                        </div>
                        <svg class="summary-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/>
                        </svg>
                    </div>
                </div>

                <!-- Schnellantwort Section -->
                <div class="dashboard-section">
                    <div class="section-header-dash">
                        <h2 class="section-title-dash">Schnellantwort</h2>
                        <button class="section-icon-btn" onclick="refreshQuickReplies()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                            </svg>
                        </button>
                    </div>
                    <div class="quick-replies">
                        <button class="quick-reply-btn" onclick="useQuickReply(this)">Ich habe die Anfrage nicht autorisiert</button>
                        <button class="quick-reply-btn" onclick="useQuickReply(this)">Ich werde die App-Berechtigungen verwalten</button>
                        <button class="quick-reply-btn" onclick="useQuickReply(this)">Ich benötige weitere Informationen zur steuerlichen Behandlung</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- E-Mail-Entwurf Tab (Active) -->
        <div class="tab-content active" id="emailTab">
            <div class="taskpane-container">
        <!-- Main Content -->
        <div class="taskpane-content" id="mainContent">
            <!-- Response Section -->
            <div class="response-section">
                <div class="response-text-wrapper">
                    <textarea class="response-text" id="responseText">Sehr geehrte Frau Becker,

vielen Dank für Ihre E-Mail zur Umsatzsteuervoranmeldung Q3 2025. Gerne helfe ich Ihnen bei der Behandlung Ihrer Softwarelizenzen:

1. Microsoft Office 365 (monatlich):
Als Software-as-a-Service gilt das Reverse-Charge-Verfahren nach § 13b UStG. Sie weisen keine deutsche Umsatzsteuer aus, können aber die Vorsteuer geltend machen. Erfassung in Kennziffer 46 und 66 der UVA.

2. Adobe Entwicklungstools (Jahresabonnement):
Ähnliche Behandlung wie Office 365. Bei Jahresabonnement erfolgt die ratierliche Erfassung über 12 Monate gemäß § 11 EStG. Dokumentation des Leistungsempfangs erforderlich.

3. AWS Cloud-Services (variabel):
Ebenfalls Reverse-Charge nach § 13b UStG. Variable Kosten werden monatlich bei Rechnungserhalt erfasst. Wichtig: Alle Rechnungen auf korrekte USt-Behandlung prüfen.

Ich empfehle ein kurzes Telefonat zur Klärung der Details. Gerne heute noch oder morgen vormittag. Dann können wir die UVA rechtzeitig fertigstellen.

Mit freundlichen Grüßen
Dr. Maria Müller
Steuerberaterin</textarea>
                    <div class="custom-scrollbar" id="customScrollbar">
                        <div class="custom-scrollbar-thumb" id="scrollbarThumb"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sources Section (Collapsible, Fixed at Bottom) -->
        <div class="sources-wrapper">
            <div class="sources-section" id="sourcesSection">
                <div class="sources-toggle" onclick="toggleSources()">
                    <div class="sources-header">
                        <div class="sources-title">
                            <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                            </svg>
                            Verwendete Quellen
                        </div>
                        <span class="sources-count">3 Dokumente</span>
                    </div>
                    <svg class="sources-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                    </svg>
                </div>
                <div class="sources-content">
                    <div class="sources-list">
                        <div class="source-card">
                            <div class="source-icon">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <div class="source-content">
                                <div class="source-title">§ 13b UStG - Reverse-Charge</div>
                                <div class="source-meta">Umsatzsteuergesetz · Aktualisiert 2025</div>
                            </div>
                        </div>
                        <div class="source-card">
                            <div class="source-icon">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                            </div>
                            <div class="source-content">
                                <div class="source-title">§ 3a Abs. 4 UStG - SaaS-Leistungen</div>
                                <div class="source-meta">Umsatzsteuergesetz · Aktualisiert 2025</div>
                            </div>
                        </div>
                        <div class="source-card">
                            <div class="source-icon">
                                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2"/>
                                </svg>
                            </div>
                            <div class="source-content">
                                <div class="source-title">Mandantenakte: Müller GmbH</div>
                                <div class="source-meta">Letzte Korrespondenz · 15.08.2025</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer with Actions -->
        <div class="taskpane-footer">
            <button class="btn-primary" onclick="insertIntoOutlook()">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/>
                </svg>
                In Outlook einfügen
            </button>
            <div class="secondary-actions">
                <button class="btn-secondary" onclick="openPromptPopup()">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                    </svg>
                    Anpassen
                </button>
            </div>
        </div>
    </div>
        </div>

        <!-- Steuer-Einsicht Tab -->
        <div class="tab-content" id="steuerTab">
            <div class="chat-container">
                <div class="chat-messages-wrapper">
                    <div class="chat-messages" id="chatMessages">
                        <!-- Initial AI Message -->
                        <div class="chat-message ai">
                            <div class="message-avatar">KI</div>
                            <div class="message-bubble">
                                Hallo! Ich bin Ihr KI-Assistent für steuerliche Fragen. Wie kann ich Ihnen heute helfen?
                            </div>
                        </div>
                    </div>
                    <div class="custom-scrollbar" id="chatMessagesScrollbar">
                        <div class="custom-scrollbar-thumb" id="chatMessagesScrollbarThumb"></div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-wrapper">
                        <div class="chat-input-container">
                            <textarea 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Nachricht eingeben..."
                                rows="1"
                                onkeydown="handleChatKeydown(event)"
                                oninput="autoResizeChatInput(this)"
                            ></textarea>
                            <div class="custom-scrollbar" id="chatInputScrollbar">
                                <div class="custom-scrollbar-thumb" id="chatInputScrollbarThumb"></div>
                            </div>
                        </div>
                        <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">
                            <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt Popup -->
    <div class="overlay" id="promptOverlay" onclick="closePopupOnOverlay(event)">
        <div class="popup" onclick="event.stopPropagation()">
            <div class="popup-header">
                <div class="popup-title">Antwort anpassen</div>
                <button class="popup-close" onclick="closePromptPopup()">×</button>
            </div>
            <div class="popup-content">
                <div class="form-group">
                    <label class="form-label">Ihr Prompt</label>
                    <div class="popup-textarea-wrapper">
                        <textarea 
                            class="form-input" 
                            id="promptInput" 
                            placeholder="Beschreiben Sie, wie die Antwort angepasst werden soll..."
                        ></textarea>
                        <div class="custom-scrollbar" id="popupScrollbar">
                            <div class="custom-scrollbar-thumb" id="popupScrollbarThumb"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="popup-footer">
                <button class="btn-cancel" onclick="closePromptPopup()">Abbrechen</button>
                <button class="btn-generate" onclick="generateWithPrompt()" id="generateBtn">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                    </svg>
                    Generieren
                </button>
            </div>
        </div>
    </div>

    <script>
        // ================================
        // CUSTOM SCROLLBAR IMPLEMENTATION
        // ================================
        
        function createCustomScrollbar(textareaId, scrollbarId, thumbId) {
            const textarea = document.getElementById(textareaId);
            const scrollbar = document.getElementById(scrollbarId);
            const thumb = document.getElementById(thumbId);
            
            if (!textarea || !scrollbar || !thumb) return;
            
            let isDragging = false;
            let startY = 0;
            let startScrollTop = 0;

            function updateScrollbar() {
                const scrollHeight = textarea.scrollHeight;
                const clientHeight = textarea.clientHeight;
                const scrollTop = textarea.scrollTop;

                // Scrollbar nur anzeigen wenn Content scrollbar ist
                if (scrollHeight > clientHeight + 1) { // +1 für Rundungsfehler
                    scrollbar.classList.add('visible');
                    
                    // Thumb-Höhe berechnen (proportional zum sichtbaren Bereich)
                    const thumbHeight = Math.max(
                        (clientHeight / scrollHeight) * clientHeight * 0.9,
                        40 // Mindesthöhe 40px
                    );
                    
                    // Thumb-Position berechnen - mit 4px Abstand oben/unten für sanfte Rundung
                    const topMargin = 4;
                    const bottomMargin = 4;
                    const scrollableHeight = clientHeight - thumbHeight - topMargin - bottomMargin;
                    const scrollPercentage = scrollTop / (scrollHeight - clientHeight);
                    const thumbTop = topMargin + (scrollPercentage * scrollableHeight);
                    
                    thumb.style.height = thumbHeight + 'px';
                    thumb.style.top = thumbTop + 'px';
                } else {
                    scrollbar.classList.remove('visible');
                    // Scrollposition zurücksetzen wenn nicht mehr scrollbar
                    if (textarea.scrollTop > 0) {
                        textarea.scrollTop = 0;
                    }
                }
            }

            // Textarea Scroll Event
            textarea.addEventListener('scroll', updateScrollbar);

            // Drag-Funktionalität für Scrollbar
            thumb.addEventListener('mousedown', (e) => {
                isDragging = true;
                startY = e.clientY;
                startScrollTop = textarea.scrollTop;
                document.body.style.userSelect = 'none';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;

                const deltaY = e.clientY - startY;
                const scrollHeight = textarea.scrollHeight;
                const clientHeight = textarea.clientHeight;
                const thumbHeight = parseFloat(thumb.style.height);
                const topMargin = 4;
                const bottomMargin = 4;
                const scrollableHeight = clientHeight - thumbHeight - topMargin - bottomMargin;
                
                const scrollDelta = (deltaY / scrollableHeight) * (scrollHeight - clientHeight);
                textarea.scrollTop = startScrollTop + scrollDelta;
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = '';
                }
            });

            // Klick auf Scrollbar-Track
            scrollbar.addEventListener('click', (e) => {
                if (e.target === scrollbar) {
                    const rect = scrollbar.getBoundingClientRect();
                    const clickY = e.clientY - rect.top;
                    const thumbHeight = parseFloat(thumb.style.height);
                    const topMargin = 4;
                    const bottomMargin = 4;
                    const scrollableHeight = rect.height - thumbHeight - topMargin - bottomMargin;
                    const scrollPercentage = (clickY - thumbHeight / 2 - topMargin) / scrollableHeight;
                    
                    const scrollHeight = textarea.scrollHeight;
                    const clientHeight = textarea.clientHeight;
                    textarea.scrollTop = scrollPercentage * (scrollHeight - clientHeight);
                }
            });

            // Initial update
            updateScrollbar();
            
            // Update bei Resize
            window.addEventListener('resize', updateScrollbar);
            
            // Update bei Content-Änderung (z.B. nach Text-Edit)
            textarea.addEventListener('input', updateScrollbar);
            
            // ResizeObserver für automatische Updates bei Größenänderungen
            if (typeof ResizeObserver !== 'undefined') {
                const resizeObserver = new ResizeObserver(() => {
                    updateScrollbar();
                });
                resizeObserver.observe(textarea);
            }
            
            return updateScrollbar;
        }
        
        function initCustomScrollbar() {
            // Haupt-Textarea Scrollbar
            const updateMainScrollbar = createCustomScrollbar('responseText', 'customScrollbar', 'scrollbarThumb');
            
            // Scrollbar als globale Funktion verfügbar machen für toggleSources
            if (updateMainScrollbar) {
                window.updateScrollbarGlobal = updateMainScrollbar;
            }
        }
        
        function initPopupScrollbar() {
            // Popup-Textarea Scrollbar
            createCustomScrollbar('promptInput', 'popupScrollbar', 'popupScrollbarThumb');
        }

        // ================================
        // POPUP FUNCTIONS
        // ================================
        
        function switchTab(tabName) {
            // Entferne active class von allen Buttons und Contents
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            // Aktiviere den entsprechenden Tab
            if (tabName === 'dashboard') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('dashboardTab').classList.add('active');
            } else if (tabName === 'email') {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('emailTab').classList.add('active');
            } else if (tabName === 'steuer') {
                document.querySelector('.tab-button:nth-child(3)').classList.add('active');
                document.getElementById('steuerTab').classList.add('active');
                
                // Initialisiere Chat Scrollbars beim ersten Öffnen
                if (!window.chatScrollbarsInitialized) {
                    setTimeout(() => {
                        initChatScrollbars();
                        window.chatScrollbarsInitialized = true;
                    }, 50);
                }
            }
        }
        
        function toggleSources() {
            const sourcesSection = document.getElementById('sourcesSection');
            sourcesSection.classList.toggle('expanded');
            
            // Scrollbar nach Transition neu berechnen
            setTimeout(() => {
                if (window.updateScrollbarGlobal) {
                    window.updateScrollbarGlobal();
                }
            }, 350); // Warten bis CSS-Transition (300ms) abgeschlossen ist
        }

        function openPromptPopup() {
            document.getElementById('promptOverlay').classList.add('active');
            document.getElementById('promptInput').focus();
            
            // Initialisiere Scrollbar beim ersten Öffnen
            if (!window.popupScrollbarInitialized) {
                setTimeout(() => {
                    initPopupScrollbar();
                    window.popupScrollbarInitialized = true;
                }, 50);
            }
        }

        function closePromptPopup() {
            document.getElementById('promptOverlay').classList.remove('active');
            document.getElementById('promptInput').value = '';
        }

        function closePopupOnOverlay(event) {
            if (event.target === event.currentTarget) {
                closePromptPopup();
            }
        }

        function generateWithPrompt() {
            const prompt = document.getElementById('promptInput').value.trim();
            
            if (!prompt) {
                alert('Bitte geben Sie einen Prompt ein.');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            const originalContent = generateBtn.innerHTML;
            
            // Loading state
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading-spinner"></span> Wird generiert...';

            // Simulate generation (in real app, this would be an API call)
            setTimeout(() => {
                // Update response with new content
                document.getElementById('responseText').value = `Sehr geehrte Frau Becker,

herzlichen Dank für Ihre Anfrage zur Umsatzsteuervoranmeldung Q3 2025.

Basierend auf Ihren Angaben habe ich eine detaillierte Analyse der steuerlichen Behandlung Ihrer Softwarelizenzen vorgenommen:

[Hier würde die mit Ihrem individuellen Prompt generierte Antwort erscheinen...]

Die vollständige Antwort berücksichtigt alle von Ihnen genannten Punkte und wurde nach Ihren spezifischen Vorgaben erstellt.

Mit freundlichen Grüßen
Dr. Maria Müller
Steuerberaterin`;

                // Update scrollbar nach Content-Änderung
                const textarea = document.getElementById('responseText');
                const event = new Event('input', { bubbles: true });
                textarea.dispatchEvent(event);

                // Reset button
                generateBtn.disabled = false;
                generateBtn.innerHTML = originalContent;
                
                // Close popup
                closePromptPopup();
                
                // Show success feedback
                showSuccessMessage();
            }, 2000);
        }

        function showSuccessMessage() {
            // Success feedback - could show a toast notification here if desired
            console.log('✅ Neue Antwort erfolgreich generiert');
        }

        // ================================
        // ACTION FUNCTIONS
        // ================================
        
        function insertIntoOutlook() {
            const responseText = document.getElementById('responseText').value;
            
            // In a real Outlook Add-in, this would use Office.js:
            // Office.context.mailbox.item.body.setAsync(responseText, { coercionType: Office.CoercionType.Text });
            
            // For demo purposes, show confirmation
            alert('Die Antwort wurde in Outlook eingefügt.\n\n(In der echten Add-in-Umgebung würde dies direkt in den E-Mail-Editor übernommen werden)');
        }

        function copyToClipboard() {
            const responseText = document.getElementById('responseText').value;
            
            navigator.clipboard.writeText(responseText).then(() => {
                // Show feedback
                const btn = event.target.closest('.btn-secondary');
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Kopiert';
                
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                }, 2000);
            }).catch(err => {
                alert('Fehler beim Kopieren: ' + err);
            });
        }

        // ================================
        // DASHBOARD FUNCTIONS
        // ================================
        
        function copySummary() {
            const summaryText = document.getElementById('summaryText').textContent;
            navigator.clipboard.writeText(summaryText).then(() => {
                const btn = event.target.closest('.section-icon-btn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>';
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                }, 2000);
            });
        }

        function expandSummary() {
            // Für Demo: könnte zu einer Detail-Ansicht führen
            console.log('Zusammenfassung erweitern');
        }

        function refreshQuickReplies() {
            const btn = event.target.closest('.section-icon-btn');
            const svg = btn.querySelector('svg');
            svg.style.transform = 'rotate(360deg)';
            svg.style.transition = 'transform 0.5s ease';
            setTimeout(() => {
                svg.style.transform = 'rotate(0deg)';
                svg.style.transition = '';
            }, 500);
            console.log('Schnellantworten aktualisiert');
        }

        function useQuickReply(button) {
            const replyText = button.textContent;
            // Wechsel zum E-Mail-Entwurf Tab und füge Text ein
            switchTab('email');
            setTimeout(() => {
                const responseText = document.getElementById('responseText');
                responseText.value = `Sehr geehrte Damen und Herren,\n\n${replyText}.\n\nMit freundlichen Grüßen`;
                // Trigger input event for scrollbar update
                responseText.dispatchEvent(new Event('input', { bubbles: true }));
            }, 100);
        }

        // ================================
        // CHAT FUNCTIONS
        // ================================
        
        function initChatScrollbars() {
            // Chat Messages Scrollbar
            createCustomScrollbar('chatMessages', 'chatMessagesScrollbar', 'chatMessagesScrollbarThumb');
            
            // Chat Input Scrollbar
            createCustomScrollbar('chatInput', 'chatInputScrollbar', 'chatInputScrollbarThumb');
        }
        
        function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Füge User-Nachricht hinzu
            addChatMessage(message, 'user');
            
            // Leere Input
            input.value = '';
            input.style.height = 'auto';
            
            // Simuliere AI-Antwort nach kurzer Verzögerung
            setTimeout(() => {
                const aiResponses = [
                    'Vielen Dank für Ihre Frage. Gemäß § 13b UStG gilt hier das Reverse-Charge-Verfahren. Ich kann Ihnen gerne weitere Details erklären.',
                    'Basierend auf den aktuellen Steuerrichtlinien empfehle ich folgende Vorgehensweise: Die Leistungen sind in der Umsatzsteuervoranmeldung unter Kennziffer 46 zu erfassen.',
                    'Ihre Anfrage betrifft einen wichtigen Aspekt der Umsatzsteuerbehandlung. Lassen Sie mich das für Sie klären und eine detaillierte Antwort formulieren.',
                    'Das ist eine sehr gute Frage! Bei grenzüberschreitenden digitalen Dienstleistungen gibt es einige Besonderheiten zu beachten.'
                ];
                const randomResponse = aiResponses[Math.floor(Math.random() * aiResponses.length)];
                addChatMessage(randomResponse, 'ai');
            }, 800);
        }

        function addChatMessage(text, type) {
            const chatMessages = document.getElementById('chatMessages');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}`;
            
            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'ai' ? 'KI' : 'Sie';
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = text;
            
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            
            chatMessages.appendChild(messageDiv);
            
            // Scroll zu neuer Nachricht
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Update Scrollbar nach kurzer Verzögerung
            setTimeout(() => {
                const event = new Event('scroll', { bubbles: true });
                chatMessages.dispatchEvent(event);
            }, 50);
        }

        function autoResizeChatInput(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            
            // Update Scrollbar
            setTimeout(() => {
                const event = new Event('scroll', { bubbles: true });
                textarea.dispatchEvent(event);
            }, 50);
        }

        function handleChatKeydown(event) {
            // Enter ohne Shift sendet Nachricht
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // ================================
        // KEYBOARD SHORTCUTS
        // ================================
        
        document.addEventListener('keydown', function(e) {
            // ESC to close popup
            if (e.key === 'Escape') {
                const overlay = document.getElementById('promptOverlay');
                if (overlay.classList.contains('active')) {
                    closePromptPopup();
                }
            }
            
            // Ctrl/Cmd + Enter to generate (when popup is open)
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                const overlay = document.getElementById('promptOverlay');
                if (overlay.classList.contains('active')) {
                    e.preventDefault();
                    generateWithPrompt();
                }
            }
        });

        // ================================
        // INITIALIZATION
        // ================================
        
        document.addEventListener('DOMContentLoaded', function() {
            console.log('✅ KanzleiPlus Outlook Taskpane geladen');
            
            // Initialize custom scrollbar
            initCustomScrollbar();
        });
    </script>
</body>
</html>